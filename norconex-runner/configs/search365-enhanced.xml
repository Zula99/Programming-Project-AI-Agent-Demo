<?xml version="1.0" encoding="UTF-8"?>
<!-- Norconex Web Crawler v3.x configuration - Search365 Schema Enhanced -->
<httpcollector id="search365-collector">

  <!-- Updated paths for Docker container -->
  <workDir>/opt/norconex/data/workdir</workDir>

  <crawlers>
    <crawler id="search365-crawler">

    <!-- Start URLs: will be dynamically replaced -->
    <startURLs stayOnDomain="true" includeSubdomains="false" stayOnProtocol="true">
        <url>https://example.com/</url>
    </startURLs>

    <!-- Crawl limits -->
    <numThreads>4</numThreads>
    <maxDocuments>500</maxDocuments>
    <maxDepth>3</maxDepth>

    <!-- Politeness -->
    <delay class="com.norconex.collector.http.delay.impl.GenericDelayResolver"
            default="2 seconds" />

    <!-- Robots / sitemaps -->
    <robotsTxt ignore="false" />
    <sitemapResolver ignore="false" />

    <!-- Reference filters - will be dynamically replaced -->
    <referenceFilters>
        <filter class="com.norconex.collector.core.filter.impl.ReferenceFilter" onMatch="include">
            <valueMatcher method="regex">^https?://([a-z0-9-]+\.)*example\.com(/.*)?$</valueMatcher>
        </filter>
        <filter class="com.norconex.collector.core.filter.impl.ExtensionReferenceFilter" onMatch="exclude">
            css,js,png,jpg,jpeg,gif,ico,zip,exe,svg,webp,mp4,mp3,woff,woff2
        </filter>
    </referenceFilters>

    <!-- Link extraction -->
    <linkExtractors>
        <extractor class="com.norconex.collector.http.link.impl.HtmlLinkExtractor"/>
    </linkExtractors>

    <!-- Enhanced importer with comprehensive metadata extraction -->
    <importer>
        <preParseHandlers>
            <!-- Core HTML metadata extraction using DOMTagger -->
            <handler class="com.norconex.importer.handler.tagger.impl.DOMTagger">
                <!-- Basic content elements -->
                <dom selector="title" toField="title" />
                <dom selector="h1" toField="htmlextractedh1" />
                <dom selector="h2" toField="htmlextractedh2" />
                <dom selector="h3" toField="htmlextractedh3" />

                <!-- Meta tags -->
                <dom selector="meta[name='description']" toField="description" extract="attr(content)" />
                <dom selector="meta[name='keywords']" toField="keywords" extract="attr(content)" />
                <dom selector="meta[name='author']" toField="author" extract="attr(content)" />
                <dom selector="meta[name='robots']" toField="robots" extract="attr(content)" />
                <dom selector="meta[name='viewport']" toField="viewport" extract="attr(content)" />

                <!-- Open Graph tags -->
                <dom selector="meta[property='og:title']" toField="ogtitle" extract="attr(content)" />
                <dom selector="meta[property='og:description']" toField="ogdescription" extract="attr(content)" />
                <dom selector="meta[property='og:type']" toField="ogtype" extract="attr(content)" />
                <dom selector="meta[property='og:url']" toField="ogurl" extract="attr(content)" />

                <!-- Twitter Card tags -->
                <dom selector="meta[name='twitter:card']" toField="twittercard" extract="attr(content)" />
                <dom selector="meta[name='twitter:site']" toField="twittersite" extract="attr(content)" />
                <dom selector="meta[name='twitter:title']" toField="twittertitle" extract="attr(content)" />
                <dom selector="meta[name='twitter:description']" toField="twitterdescription" extract="attr(content)" />

                <!-- Contact information -->
                <dom selector="meta[name='contact.email']" toField="email" extract="attr(content)" />
                <dom selector="meta[name='contact.phone']" toField="phone" extract="attr(content)" />
                <dom selector="meta[name='address']" toField="address" extract="attr(content)" />
                <dom selector="meta[name='geo.position']" toField="locationgeo" extract="attr(content)" />

                <!-- Technical meta -->
                <dom selector="meta[name='generator']" toField="xparsedby" extract="attr(content)" />
                <dom selector="meta[name='google-site-verification']" toField="googlesiteverification" extract="attr(content)" />
            </handler>

            <!-- Add static Search365 fields using ConstantTagger -->
            <handler class="com.norconex.importer.handler.tagger.impl.ConstantTagger">
                <constant field="contentfamily">Web</constant>
                <constant field="category">Web Page</constant>
                <constant field="collection">web_crawl</constant>
                <constant field="access">public</constant>
                <constant field="dacl">public</constant>
                <constant field="tags">web,crawled</constant>
                <constant field="contentpurpose">information</constant>
                <constant field="topicarea">general</constant>
                <constant field="age">0</constant>
                <constant field="extension">html</constant>
            </handler>
        </preParseHandlers>

        <postParseHandlers>
            <!-- Copy document.reference to multiple fields for Search365 compatibility -->
            <handler class="com.norconex.importer.handler.tagger.impl.CopyTagger">
                <copy fromField="document.reference" toField="datasource" />
                <copy fromField="document.reference" toField="sitename" />
                <copy fromField="document.reference" toField="systemtitle" />
                <copy fromField="document.reference" toField="documentreference" />
                <copy fromField="document.contentType" toField="documentcontenttype" />
                <copy fromField="document.contentEncoding" toField="documentcontentencoding" />
            </handler>
        </postParseHandlers>
    </importer>

    <!-- ===== COMMITTERS ===== -->
    <committers>
        <!-- Local XML mirror (for debugging/visibility) -->
        <committer class="com.norconex.committer.core3.fs.impl.XMLFileCommitter">
            <directory>/opt/norconex/data/xml-output</directory>
            <docsPerFile>200</docsPerFile>
            <splitUpsertDelete>true</splitUpsertDelete>
            <fileNamePrefix>search365-enhanced-</fileNamePrefix>
            <indent>2</indent>
        </committer>

        <!-- OpenSearch committer with comprehensive Search365 field mappings -->
        <committer class="com.norconex.committer.elasticsearch.ElasticsearchCommitter">
            <nodes>http://opensearch:9200</nodes>
            <indexName>demo_factory</indexName>

            <ignoreResponseErrors>false</ignoreResponseErrors>
            <connectionTimeout>30000</connectionTimeout>
            <socketTimeout>30000</socketTimeout>

            <sourceIdField>document.reference</sourceIdField>

            <!-- Comprehensive field mappings for Search365 schema -->
            <fieldMappings>
                <!-- Core fields -->
                <mapping fromField="document.reference" toField="id" />
                <mapping fromField="document.reference" toField="url" />
                <mapping fromField="document.reference" toField="location" />
                <mapping fromField="title" toField="title" />
                <mapping fromField="content" toField="content" />
                <mapping fromField="description" toField="description" />
                <mapping fromField="keywords" toField="keywords" />
                <mapping fromField="author" toField="author" />

                <!-- Search365 specific fields -->
                <mapping fromField="contentfamily" toField="contentfamily" />
                <mapping fromField="category" toField="category" />
                <mapping fromField="collection" toField="collection" />
                <mapping fromField="access" toField="access" />
                <mapping fromField="dacl" toField="dacl" />
                <mapping fromField="tags" toField="tags" />
                <mapping fromField="contentpurpose" toField="contentpurpose" />
                <mapping fromField="topicarea" toField="topicarea" />
                <mapping fromField="age" toField="age" />
                <mapping fromField="extension" toField="extension" />
                <mapping fromField="datasource" toField="datasource" />
                <mapping fromField="sitename" toField="sitename" />
                <mapping fromField="systemtitle" toField="systemtitle" />

                <!-- Contact and location fields -->
                <mapping fromField="email" toField="email" />
                <mapping fromField="phone" toField="phone" />
                <mapping fromField="address" toField="address" />
                <mapping fromField="locationgeo" toField="locationgeo" />

                <!-- HTML extracted fields -->
                <mapping fromField="htmlextractedh1" toField="htmlextractedh1" />
                <mapping fromField="htmlextractedh2" toField="htmlextractedh2" />
                <mapping fromField="htmlextractedh3" toField="htmlextractedh3" />

                <!-- Open Graph -->
                <mapping fromField="ogtitle" toField="ogtitle" />
                <mapping fromField="ogdescription" toField="ogdescription" />
                <mapping fromField="ogtype" toField="ogtype" />
                <mapping fromField="ogurl" toField="ogurl" />

                <!-- Twitter Card -->
                <mapping fromField="twittercard" toField="twittercard" />
                <mapping fromField="twittersite" toField="twittersite" />
                <mapping fromField="twittertitle" toField="twittertitle" />
                <mapping fromField="twitterdescription" toField="twitterdescription" />

                <!-- Meta tags -->
                <mapping fromField="robots" toField="robots" />
                <mapping fromField="viewport" toField="viewport" />
                <mapping fromField="xparsedby" toField="xparsedby" />
                <mapping fromField="googlesiteverification" toField="googlesiteverification" />

                <!-- Technical document fields -->
                <mapping fromField="document.contentType" toField="contenttype" />
                <mapping fromField="document.contentEncoding" toField="encoding" />
                <mapping fromField="documentcontenttype" toField="documentcontenttype" />
                <mapping fromField="documentcontentencoding" toField="documentcontentencoding" />
                <mapping fromField="documentreference" toField="documentreference" />
            </fieldMappings>

            <!-- Queue configuration -->
            <queue class="com.norconex.committer.core3.batch.queue.impl.FSQueue">
                <batchSize>50</batchSize>
                <maxPerFolder>500</maxPerFolder>
                <commitLeftoversOnInit>true</commitLeftoversOnInit>
                <onCommitFailure>
                    <maxRetries>3</maxRetries>
                    <retryDelay>5000</retryDelay>
                    <ignoreErrors>false</ignoreErrors>
                </onCommitFailure>
            </queue>
        </committer>
    </committers>

    </crawler>
  </crawlers>

</httpcollector>